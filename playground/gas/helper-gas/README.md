# ğŸ”‘ KEYVOX API Helper for Google Apps Script

## æ¦‚è¦

ã“ã®Google Apps Script (GAS) ã¯ã€KEYVOX APIã‚’Googleã®ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã€Gmailã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãªã©ï¼‰ã‹ã‚‰ç°¡å˜ã«åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚
è¤‡é›‘ãªHMAC-SHA256ç½²åèªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•çš„ã«å‡¦ç†ã™ã‚‹ãŸã‚ã€é–‹ç™ºè€…ã¯APIã®å„æ©Ÿèƒ½ã‚’ã‚·ãƒ³ãƒ—ãƒ«ãªé–¢æ•°å‘¼ã³å‡ºã—ã§åˆ©ç”¨ã§ãã¾ã™ã€‚

## âœ¨ ä¸»ãªæ©Ÿèƒ½

- è¤‡é›‘ãªHMAC-SHA256ç½²åèªè¨¼ã‚’è‡ªå‹•çš„ã«å‡¦ç†
- `PropertiesService` ã‚’åˆ©ç”¨ã—ã€ã‚³ãƒ¼ãƒ‰å†…ã«ç›´æ¥ã‚­ãƒ¼ã‚’è¨˜è¿°ã—ãªã„å®‰å…¨ãªAPIã‚­ãƒ¼ç®¡ç†ã‚’å®Ÿç¾
- PINã‚³ãƒ¼ãƒ‰ä½œæˆã€é éš”è§£éŒ ãªã©ã€ä¸€èˆ¬çš„ãªæ“ä½œã®ãŸã‚ã®é«˜ãƒ¬ãƒ™ãƒ«ãªé–¢æ•°ã‚’æä¾›
- ãƒˆãƒªã‚¬ãƒ¼ï¼ˆæ™‚é–“ãƒ™ãƒ¼ã‚¹ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç·¨é›†æ™‚ãªã©ï¼‰ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€æ§˜ã€…ãªæ¥­å‹™ã‚’è‡ªå‹•åŒ–

## âš™ï¸ 1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¨­ç½®

1.  Google Apps Scriptã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–°è¦ä½œæˆã€ã¾ãŸã¯æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ãã¾ã™ã€‚
2.  æä¾›ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ (`.gs`ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹) ã‚’å…¨ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—2: APIã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã®è¨­å®š

APIã®èªè¨¼æƒ…å ±ã‚’å®‰å…¨ã«ä¿ç®¡ã™ã‚‹ãŸã‚ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

1.  ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã§ã€`storeKeys` é–¢æ•°å†…ã«ã‚ã‚‹ä»¥ä¸‹ã®2è¡Œã‚’ã€ã‚ãªãŸã®APIã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã«æ›¸ãæ›ãˆã¾ã™ã€‚
    ```javascript
    scriptProperties.setProperty('API_KEY', 'ã“ã“ã«è‡ªåˆ†ã®APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã‚‹');
    scriptProperties.setProperty('SECRET_KEY', 'ã“ã“ã«è‡ªåˆ†ã®APIã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼è²¼ã‚Šä»˜ã‘ã‚‹');
    ```
2.  ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã®ä¸Šéƒ¨ã«ã‚ã‚‹é–¢æ•°é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰ `storeKeys` ã‚’é¸æŠã—ã€`â–¶ å®Ÿè¡Œ` ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¸€åº¦ã ã‘å®Ÿè¡Œã—ã¾ã™ã€‚
3.  å®Ÿè¡ŒãŒå®Œäº†ã™ã‚‹ã¨ã€APIã‚­ãƒ¼ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
4.  **ã€é‡è¦ã€‘** ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€`storeKeys` é–¢æ•°ã«è¨˜è¿°ã—ãŸå®Ÿéš›ã®ã‚­ãƒ¼ã¯å‰Šé™¤ã—ã€å…ƒã® `'ã“ã“ã«ã€œ'` ã®çŠ¶æ…‹ã«æˆ»ã—ã¦ãŠãã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—3: å®šæ•°ã®è¨­å®š

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¸Šéƒ¨ã«ã‚ã‚‹å®šæ•°ï¼ˆ`UNIT_ID`, `LOCK_ID`, `DEVICE_ID`ï¼‰ã‚’ã€æ“ä½œã—ãŸã„å¯¾è±¡ã«å¿œã˜ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã‚‰ã®IDã¯ã€KEYVOXã®ç®¡ç†ç”»é¢ã‚„ã€åˆ¥é€”APIï¼ˆä¾‹: `getUnit`ï¼‰ã§å–å¾—ã§ãã¾ã™ã€‚

```javascript
// å¿…è¦ãªå®šæ•°ã®å®£è¨€
const UNIT_ID = "your_unit_id_value"; //ãƒ‰ã‚¢ã®IDã‚’getUnitAPIã§å–å¾—
const LOCK_ID = "your_lock_id_value"; //ãƒ­ãƒƒã‚¯ã®IDã‚’getUnitAPIã§å–å¾—
const DEVICE_ID = "your_device_id_value"; //ãƒ­ãƒƒã‚«ãƒ¼ã®IDã‚’getUnitAPIã§å–å¾—
```

## ğŸš€ 2. ä½¿ã„æ–¹ (APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹)

ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ãŸã‚‰ã€å„ã‚µãƒ³ãƒ—ãƒ«é–¢æ•°ã‚’ãã®ã¾ã¾åˆ©ç”¨ã—ãŸã‚Šã€ç‹¬è‡ªã®é–¢æ•°ã‹ã‚‰å‘¼ã³å‡ºã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚é–¢æ•°ã®å®Ÿè¡Œçµæœã¯ `Logger.log()` ã‚’ä½¿ã£ã¦ç¢ºèªã§ãã¾ã™ã€‚ï¼ˆ`è¡¨ç¤º`ãƒ¡ãƒ‹ãƒ¥ãƒ¼ > `ãƒ­ã‚°`ï¼‰

---

### `createLockPinFromGmail(pin, stime, etime, targetName)`

ã‚¹ãƒãƒ¼ãƒˆãƒ­ãƒƒã‚¯ã®PINã‚³ãƒ¼ãƒ‰ï¼ˆæš—è¨¼ç•ªå·ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**
| å¼•æ•° | å‹ | èª¬æ˜ |
| :--- | :--- | :--- |
| `pin` | `string` | è¨­å®šã—ãŸã„PINã‚³ãƒ¼ãƒ‰ã€‚ |
| `stime` | `string` | PINã‚³ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚‹é–‹å§‹æ™‚åˆ»ï¼ˆUnixã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®æ–‡å­—åˆ—ï¼‰ã€‚ |
| `etime` | `string` | PINã‚³ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã«ãªã‚‹çµ‚äº†æ™‚åˆ»ï¼ˆUnixã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®æ–‡å­—åˆ—ï¼‰ã€‚ |
| `targetName` | `string` | ã‚«ã‚®ã‚’åˆ©ç”¨ã™ã‚‹åˆ©ç”¨è€…åã€‚ |

**ä½¿ç”¨ä¾‹**
Gmailã®å—ä¿¡ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã—ã¦ã€æ–°ã—ã„PINã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹ãªã©ã®å¿œç”¨ãŒå¯èƒ½ã§ã™ã€‚

```javascript
function createNewPinSample() {
  const unitId = UNIT_ID; // äº‹å‰ã«è¨­å®šã—ãŸå®šæ•°ã‚’åˆ©ç”¨
  const newPin = '123456';
  const startTime = Math.floor(Date.now() / 1000).toString(); // ç¾åœ¨æ™‚åˆ»
  const endTime = (Math.floor(Date.now() / 1000) + 3600).toString(); // 1æ™‚é–“å¾Œ
  const userName = 'Test User';

  const response = createLockPinFromGmail(newPin, startTime, endTime, userName);
  Logger.log(response.getContentText()); // APIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
}
```

---

### `unlockLock()`

æŒ‡å®šã—ãŸã‚¹ãƒãƒ¼ãƒˆãƒ­ãƒƒã‚¯ã‚’é éš”ã§è§£éŒ ã—ã¾ã™ã€‚ï¼ˆäº‹å‰ã«å®šæ•° `LOCK_ID` ã®è¨­å®šãŒå¿…è¦ã§ã™ï¼‰

**ä½¿ç”¨ä¾‹**
```javascript
function unlockSample() {
  const response = unlockLock();
  Logger.log(response.getContentText());
}
```

---

### `unlockLocker(boxNum)`

æŒ‡å®šã—ãŸå®…é…ãƒœãƒƒã‚¯ã‚¹ãªã©ã‚’é éš”ã§è§£éŒ ã—ã¾ã™ã€‚ï¼ˆäº‹å‰ã«å®šæ•° `DEVICE_ID` ã®è¨­å®šãŒå¿…è¦ã§ã™ï¼‰

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**
| å¼•æ•° | å‹ | èª¬æ˜ |
| :--- | :--- | :--- |
| `boxNum` | `string` or `number` | è§£éŒ ã—ãŸã„ãƒœãƒƒã‚¯ã‚¹ã®ç•ªå·ã€‚ |

**ä½¿ç”¨ä¾‹**
ã“ã®é–¢æ•°ã¯APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åˆ¤å®šã—ã€æˆåŠŸãƒ»å¤±æ•—ã«å¿œã˜ãŸæ—¥æœ¬èªã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã—ã¾ã™ã€‚
```javascript
function openLockerSample() {
  const boxNumber = '3';
  const message = unlockLocker(boxNumber);
  Logger.log(message); // "è§£éŒ ã—ã¾ã—ãŸã€‚..." or "ãƒ­ãƒƒã‚«ãƒ¼ã®è§£éŒ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚..."
}
```

---

### ğŸ§° ä½ãƒ¬ãƒ™ãƒ«API: `callApi(apiName, postParam)`

æä¾›ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«ä»¥å¤–ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ãŸã„å ´åˆã€ã“ã®æ±ç”¨é–¢æ•°ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚KEYVOX APIã®ä»•æ§˜æ›¸ã‚’ç¢ºèªã—ã€`apiName`ã¨`postParam`ã‚’é©åˆ‡ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**
| å¼•æ•° | å‹ | èª¬æ˜ |
| :--- | :--- | :--- |
| `apiName` | `string` | å‘¼ã³å‡ºã—ãŸã„APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåï¼ˆä¾‹: `createLockPin`ï¼‰ã€‚ |
| `postParam` | `string` | APIã«é€ä¿¡ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã€‚`JSON.stringify()` ã§æ–‡å­—åˆ—åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ |


**ä½¿ç”¨ä¾‹: (`getLockList` ã¨ã„ã†APIãŒã‚ã‚‹å ´åˆ)**
```javascript
function getListOfLocks() {
  // æ³¨æ„: ã“ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯æ¶ç©ºã®ã‚‚ã®ã§ã™ã€‚
  // å®Ÿéš›ã®APIä»•æ§˜ã«åˆã‚ã›ã¦ apiName ã¨ postParam ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
  const apiNameToCall = 'getLockList';
  const params = {
    page: 1,
    limit: 10
  };

  const response = callApi(apiNameToCall, JSON.stringify(params));
  if (response) {
    Logger.log(response.getContentText());
  }
}
```